spring:
  cloud:
    config:
      enabled: true
    gateway:
      globalcors:
        cors-configurations:
          "[/**]":
            allowedOrigins:
              - ${FRONTEND_URL:https://shopmall.com}
              - ${ADMIN_URL:https://admin.shopmall.com}
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
              - HEAD
              - PATCH
            allowedHeaders: "*"
            allowCredentials: true
            maxAge: 3600

      default-filters:
        - name: DedupeResponseHeader
          args:
            name: Access-Control-Allow-Origin Access-Control-Allow-Credentials
            strategy: RETAIN_UNIQUE

      routes:
        # ===========================================
        # ğŸ”¥ PRODUCT CATALOG SERVICE ë¼ìš°íŒ… (í†µí•© ì„œë¹„ìŠ¤)
        # ===========================================

        # 1. ìƒí’ˆ API ë¼ìš°íŒ…
        # ìƒí’ˆ ìƒì„¸ ì¡°íšŒ (íŠ¹ì • ID) - ìš°ì„ ìˆœìœ„ ë†’ìŒ
        - id: product-detail-public
          uri: lb://product-catalog-service
          predicates:
            - Path=/api/products/{productId}
            - Method=GET
          filters:
            - name: RewritePath
              args:
                regexp: /api/products/(?<productId>.*)
                replacement: /api/products/${productId}

        # ìƒí’ˆ í•„í„°ë§ ì¡°íšŒ
        - id: product-filter-public
          uri: lb://product-catalog-service
          predicates:
            - Path=/api/products/filter
            - Method=GET

        # ì¹´í…Œê³ ë¦¬ë³„ ìƒí’ˆ ì¡°íšŒ
        - id: product-category-public
          uri: lb://product-catalog-service
          predicates:
            - Path=/api/products/category/{categoryId}
            - Method=GET

        # ì—°ê´€ ìƒí’ˆ ì¡°íšŒ
        - id: product-related-public
          uri: lb://product-catalog-service
          predicates:
            - Path=/api/products/{productId}/related
            - Method=GET

        # ì¶”ì²œ ìƒí’ˆ ì¡°íšŒ
        - id: product-recommended-public
          uri: lb://product-catalog-service
          predicates:
            - Path=/api/products/recommended
            - Method=GET

        # í˜¸ìŠ¤íŠ¸ë³„ ìƒí’ˆ ì¡°íšŒ
        - id: product-host-public
          uri: lb://product-catalog-service
          predicates:
            - Path=/api/products/host/{hostId}
            - Method=GET

        # ìƒí’ˆ í†µê³„ ì¡°íšŒ
        - id: product-stats-public
          uri: lb://product-catalog-service
          predicates:
            - Path=/api/products/stats/**
            - Method=GET

        # ê²ŒìŠ¤íŠ¸ ì¥ë°”êµ¬ë‹ˆ ìƒì„¸ ì¡°íšŒ
        - id: product-guest-cart-public
          uri: lb://product-catalog-service
          predicates:
            - Path=/api/products/guest-cart-details
            - Method=POST

        # ì´ë¯¸ì§€ í¬í•¨ ìƒí’ˆ ì¡°íšŒ APIë“¤
        - id: product-with-images-public
          uri: lb://product-catalog-service
          predicates:
            - Path=/api/products/{productId}/with-images
            - Method=GET

        - id: product-category-with-images-public
          uri: lb://product-catalog-service
          predicates:
            - Path=/api/products/category/{categoryId}/with-images
            - Method=GET

        - id: product-related-with-images-public
          uri: lb://product-catalog-service
          predicates:
            - Path=/api/products/{productId}/related/with-images
            - Method=GET

        # ì „ì²´ ìƒí’ˆ ì¡°íšŒ (ë§ˆì§€ë§‰ì— ë°°ì¹˜)
        - id: product-list-public
          uri: lb://product-catalog-service
          predicates:
            - Path=/api/products
            - Method=GET

        # ìƒí’ˆ ê´€ë¦¬ API (ê´€ë¦¬ììš©)
        - id: product-management-protected
          uri: lb://product-catalog-service
          predicates:
            - Path=/api/products/**
            - Method=POST,PUT,DELETE,PATCH
          filters:
            - name: JwtAuthorization

        # 2. ì¹´í…Œê³ ë¦¬ API ë¼ìš°íŒ…
        # ë©”ì¸ ì¹´í…Œê³ ë¦¬ ì¡°íšŒ
        - id: category-main-public
          uri: lb://product-catalog-service
          predicates:
            - Path=/api/categories/main
            - Method=GET

        # ê³„ì¸µí˜• ì¹´í…Œê³ ë¦¬ ì¡°íšŒ
        - id: category-hierarchy-public
          uri: lb://product-catalog-service
          predicates:
            - Path=/api/categories/hierarchy
            - Method=GET

        # íŠ¹ì • ì¹´í…Œê³ ë¦¬ í•˜ìœ„ ì¡°íšŒ
        - id: category-sub-public
          uri: lb://product-catalog-service
          predicates:
            - Path=/api/categories/{categoryId}/sub
            - Method=GET

        # ì¹´í…Œê³ ë¦¬ í•˜ìœ„ ID ì¡°íšŒ
        - id: category-children-ids-public
          uri: lb://product-catalog-service
          predicates:
            - Path=/api/categories/{categoryId}/children-ids
            - Method=GET

        # ì¹´í…Œê³ ë¦¬ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        - id: category-exists-public
          uri: lb://product-catalog-service
          predicates:
            - Path=/api/categories/{categoryId}/exists
            - Method=GET

        # íŠ¹ì • ì¹´í…Œê³ ë¦¬ ìƒì„¸ ì¡°íšŒ
        - id: category-detail-public
          uri: lb://product-catalog-service
          predicates:
            - Path=/api/categories/{categoryId}
            - Method=GET

        # ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ API (ê´€ë¦¬ììš©)
        - id: category-management-protected
          uri: lb://product-catalog-service
          predicates:
            - Path=/api/categories/**
            - Method=POST,PUT,DELETE,PATCH
          filters:
            - name: JwtAuthorization

        # 3. ì´ë¯¸ì§€ API ë¼ìš°íŒ…
        # ì •ì  ì´ë¯¸ì§€ íŒŒì¼ ì„œë¹™
        - id: image-static-files
          uri: lb://product-catalog-service
          predicates:
            - Path=/images/**
            - Method=GET

        # ìƒí’ˆ ì´ë¯¸ì§€ ì„œë¹™
        - id: image-products-files
          uri: lb://product-catalog-service
          predicates:
            - Path=/api/images/products/{fileName}
            - Method=GET

        # ì¸ë„¤ì¼ ì´ë¯¸ì§€
        - id: image-thumbnail-files
          uri: lb://product-catalog-service
          predicates:
            - Path=/api/images/products/{fileName}/thumb
            - Method=GET

        # ìƒí’ˆë³„ ì´ë¯¸ì§€ ì¡°íšŒ API
        - id: image-product-images-public
          uri: lb://product-catalog-service
          predicates:
            - Path=/api/images/products/{productId}
            - Method=GET

        # ë©”ì¸ ì´ë¯¸ì§€ ì¡°íšŒ
        - id: image-main-public
          uri: lb://product-catalog-service
          predicates:
            - Path=/api/images/products/{productId}/main
            - Method=GET

        # ì´ë¯¸ì§€ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        - id: image-exists-public
          uri: lb://product-catalog-service
          predicates:
            - Path=/api/images/products/{productId}/exists
            - Method=GET

        # ë©”ì¸ ì´ë¯¸ì§€ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        - id: image-main-exists-public
          uri: lb://product-catalog-service
          predicates:
            - Path=/api/images/products/{productId}/main/exists
            - Method=GET

        # ë³µìˆ˜ ìƒí’ˆ ë©”ì¸ ì´ë¯¸ì§€ ì¡°íšŒ
        - id: image-main-bulk-public
          uri: lb://product-catalog-service
          predicates:
            - Path=/api/images/products/main
            - Method=POST

        # ë³µìˆ˜ ìƒí’ˆ ì „ì²´ ì´ë¯¸ì§€ ì¡°íšŒ
        - id: image-all-bulk-public
          uri: lb://product-catalog-service
          predicates:
            - Path=/api/images/products/all
            - Method=POST

        # ê°œë³„ ì´ë¯¸ì§€ ì¡°íšŒ (IDë³„)
        - id: image-by-id-public
          uri: lb://product-catalog-service
          predicates:
            - Path=/api/images/{productId}
            - Method=GET

        # ê°œë³„ ë©”ì¸ ì´ë¯¸ì§€ ì¡°íšŒ (IDë³„)
        - id: image-main-by-id-public
          uri: lb://product-catalog-service
          predicates:
            - Path=/api/images/{productId}/main
            - Method=GET

        # ì´ë¯¸ì§€ ê´€ë¦¬ API (ê´€ë¦¬ììš©)
        - id: image-upload-protected
          uri: lb://product-catalog-service
          predicates:
            - Path=/api/images
            - Method=POST
          filters:
            - name: JwtAuthorization

        - id: image-delete-protected
          uri: lb://product-catalog-service
          predicates:
            - Path=/api/images/{imageId}
            - Method=DELETE
          filters:
            - name: JwtAuthorization

        # 4. ìºì‹œ ê´€ë¦¬ API (ê´€ë¦¬ììš©)
        - id: cache-management-protected
          uri: lb://product-catalog-service
          predicates:
            - Path=/api/cache/**
          filters:
            - name: JwtAuthorization

        # ===========================================
        # ğŸ”¥ í†µí•©ëœ ORDER SERVICE ë¼ìš°íŒ… (Order + Cart + Payment)
        # ===========================================

        # AUTH SERVICE
        - id: auth-service-public
          uri: lb://auth-service
          predicates:
            - Path=/auth/**

        # ===========================================
        # ğŸ”¥ USER SERVICE ë¼ìš°íŒ… (Board + QnA í†µí•©ë¨)
        # ===========================================

        # USER SERVICE ê³µê°œ API
        - id: user-service-register-public
          uri: lb://user-service
          predicates:
            - Path=/api/users/register,/api/users/checkUserId,/api/users/findId
            - Method=GET,POST

        # USER SERVICE ë³´í˜¸ëœ API
        - id: user-service-protected
          uri: lb://user-service
          predicates:
            - Path=/api/users/**
          filters:
            - name: JwtAuthorization

        # ===========================================
        # ğŸ”¥ BOARD/QNA SERVICE - user-serviceë¡œ í†µí•©ë¨
        # ===========================================

        # BOARD/QNA ê³µê°œ API (ì¡°íšŒìš©) - user-serviceë¡œ ë³€ê²½
        - id: board-qna-service-public
          uri: lb://user-service # âœ… board-service â†’ user-serviceë¡œ ë³€ê²½
          predicates:
            - Path=/api/board/**,/api/qna/**
            - Method=GET

        # BOARD/QNA ë³´í˜¸ëœ API (ì‘ì„±/ìˆ˜ì •/ì‚­ì œìš©) - user-serviceë¡œ ë³€ê²½
        - id: board-qna-service-protected
          uri: lb://user-service # âœ… board-service â†’ user-serviceë¡œ ë³€ê²½
          predicates:
            - Path=/api/board/**,/api/qna/**
            - Method=POST,PUT,DELETE,PATCH
          filters:
            - name: JwtAuthorization

        # ===========================================
        # ğŸ”¥ ê¸°íƒ€ ì„œë¹„ìŠ¤ ë¼ìš°íŒ…
        # ===========================================

        # ğŸ”¥ CART SERVICE (order-serviceë¡œ í†µí•©ë¨)
        - id: cart-service-integrated
          uri: lb://order-service
          predicates:
            - Path=/api/cart/**
          filters:
            - name: JwtAuthorization

        # ğŸ”¥ ORDER SERVICE (ê¸°ì¡´ ìœ ì§€)
        - id: order-service-protected
          uri: lb://order-service
          predicates:
            - Path=/api/orders/**
          filters:
            - name: JwtAuthorization

        # ğŸ”¥ PAYMENT SERVICE (order-serviceë¡œ í†µí•©ë¨)
        - id: payment-service-integrated
          uri: lb://order-service
          predicates:
            - Path=/api/payments/**
          filters:
            - name: JwtAuthorization

        # NOTIFICATION SERVICE
        - id: notification-service-protected
          uri: lb://notification-service
          predicates:
            - Path=/api/notifications/**
          filters:
            - name: JwtAuthorization

        # LIVE STREAMING SERVICE
        - id: live-streaming-service-public
          uri: lb://live-streaming-service
          predicates:
            - Path=/api/streaming/**
            - Method=GET

        - id: live-streaming-service-protected
          uri: lb://live-streaming-service
          predicates:
            - Path=/api/streaming/**
            - Method=POST,PUT,DELETE,PATCH
          filters:
            - name: JwtAuthorization

        # LIVE CHAT SERVICE
        - id: live-chat-service-protected
          uri: lb://live-chat-service
          predicates:
            - Path=/api/chat/**
          filters:
            - name: JwtAuthorization

# Eureka ì„¤ì •
eureka:
  client:
    service-url:
      defaultZone: ${EUREKA_URL:http://eureka-server:8761/eureka/}
  instance:
    hostname: ${EUREKA_HOSTNAME:apigateway-service}
    prefer-ip-address: true
    instance-id: ${spring.application.name}:${spring.application.instance_id:${server.port}}
    lease-renewal-interval-in-seconds: 10
    lease-expiration-duration-in-seconds: 30

# ë¡œê¹… ì„¤ì •
logging:
  level:
    org.springframework.cloud.gateway: INFO
    org.springframework.cloud.gateway.handler.RoutePredicateHandlerMapping: DEBUG # âœ… ë¼ìš°íŒ… ë””ë²„ê¹… ì¶”ê°€
    org.kosa.apigatewayservice: INFO
    reactor.netty.http.client: WARN
    org.springframework.cloud.netflix.eureka: WARN

# ì„œë²„ ì„¤ì • (ìš´ì˜í™˜ê²½)
server:
  port: ${SERVER_PORT:8080}

# ê´€ë¦¬ ì—”ë“œí¬ì¸íŠ¸ (ìš´ì˜í™˜ê²½)
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,gateway # âœ… gateway ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€
  endpoint:
    health:
      show-details: when_authorized
    gateway:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true

# JWT ì„¤ì • (ìš´ì˜í™˜ê²½ìš©)
jwt:
  secret: ${JWT_SECRET:verySecretKeyThatIsAtLeast32BytesLong1234}
  expiration: ${JWT_EXPIRATION:86400000}
